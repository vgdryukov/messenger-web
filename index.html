<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Messenger</title>
    <style>
        /* –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
        body {
            background-image: url('https://images.unsplash.com/photo-1556761175-5973dc0f32e7');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ */
        #serverConfig {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
        }

        .config-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .config-form h2 {
            color: #333;
            margin-bottom: 10px;
            font-weight: 300;
            font-size: 28px;
        }

        .config-form p {
            color: #666;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .config-form input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
        }

        .config-form input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
            background: white;
        }

        .config-form .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .config-form button {
            flex: 1;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .config-form button.save {
            background: linear-gradient(135deg, #34c759, #28a745);
        }

        .config-form .examples {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }

        .config-form .examples strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        #app {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            max-width: 1200px;
            width: 95%;
            min-height: 600px;
            margin: 20px auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .app-header h1 {
            color: #333;
            margin: 0;
            font-weight: 300;
            font-size: 28px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .username {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }

        .server-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4a90e2;
        }

        .server-info .label {
            font-weight: 600;
            color: #333;
            margin-right: 10px;
        }

        .server-info .address {
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .change-server-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            float: right;
        }

        /* Layout –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ */
        .messenger-container {
            display: flex;
            gap: 20px;
            height: 500px;
        }

        .sidebar {
            width: 300px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .chat-area {
            flex: 1;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ */
        .list-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .contacts-list, .groups-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .contact-item, .group-item {
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .contact-item:hover, .group-item:hover {
            border-color: #4a90e2;
            transform: translateY(-2px);
        }

        .contact-item.active, .group-item.active {
            border-color: #4a90e2;
            background: #e3f2fd;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 15px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.own {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.other {
            background: #f8f9fa;
            color: #333;
            border-bottom-left-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .message-header {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .message-content {
            font-size: 14px;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
        }

        .message-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .send-btn {
            background: linear-gradient(135deg, #34c759, #28a745);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        /* –§–æ—Ä–º—ã */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .form-container h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #34c759, #28a745);
        }

        .notification.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffd60a, #ffc300);
            color: #333;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div id="serverConfig">
        <div class="config-form">
            <h2>üîó P2P Messenger</h2>
            <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞</p>
            
            <input type="text" id="serverInput" placeholder="–í–≤–µ–¥–∏—Ç–µ server:port" value="localhost:8080">
            
            <div class="button-group">
                <button onclick="connectToServer()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <button onclick="saveAndConnect()" class="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            
            <div class="examples">
                <strong>–ü—Ä–∏–º–µ—Ä—ã —Å–µ—Ä–≤–µ—Ä–æ–≤:</strong>
                localhost:8080<br>
                192.168.1.100:8080<br>
                myserver.com:8080
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app">
        <div class="app-header">
            <h1>üí¨ P2P Messenger</h1>
            <div class="user-info">
                <span class="username" id="currentUsername">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                <button class="change-server-btn" onclick="showConfig()">
                    ‚öôÔ∏è –°–º–µ–Ω–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
                </button>
            </div>
        </div>
        
        <div class="server-info">
            <span class="label">üìç –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫:</span>
            <span class="address" id="currentServer">...</span>
            <div style="clear: both;"></div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
        <div class="messenger-container">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="sidebar">
                <div class="auth-section">
                    <button onclick="showLoginForm()" id="loginBtn" class="send-btn" style="width: 100%; margin-bottom: 10px;">
                        üîë –í–æ–π—Ç–∏
                    </button>
                    <button onclick="showRegisterForm()" id="registerBtn" class="send-btn" style="width: 100%; background: linear-gradient(135deg, #6c757d, #5a6268);">
                        üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </button>
                </div>

                <div class="list-header">üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
                <div class="contacts-list" id="contactsList">
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>

                <div class="list-header">üë• –ì—Ä—É–ø–ø—ã</div>
                <div class="groups-list" id="groupsList">
                    <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>

                <button onclick="showAddContactForm()" class="send-btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
                </button>
                <button onclick="showCreateGroupForm()" class="send-btn" style="background: linear-gradient(135deg, #ffd60a, #ffc300); color: #333; margin-top: 10px;">
                    üè† –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                </button>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
            <div class="chat-area">
                <div class="chat-header">
                    <h3 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</h3>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ P2P Messenger!</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –≥—Ä—É–ø–ø—É —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                    </div>
                </div>

                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="message-input" disabled>
                    <button onclick="sendMessage()" id="sendBtn" class="send-btn" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –ª–æ–≥–∏–Ω–∞ -->
    <div id="loginForm" class="form-overlay">
        <div class="form-container">
            <h3>üîë –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="form-actions">
                <button onclick="performLogin()" class="btn-primary">–í–æ–π—Ç–∏</button>
                <button onclick="hideLoginForm()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="showRecoveryForm()" style="color: #4a90e2; text-decoration: none;">
                    –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?
                </a>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="registerForm" class="form-overlay">
        <div class="form-container">
            <h3>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (3-16 —Å–∏–º–≤–æ–ª–æ–≤):</label>
                <input type="text" id="registerUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å (6-32 —Å–∏–º–≤–æ–ª–∞):</label>
                <input type="password" id="registerPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="form-group">
                <label>Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="email" id="registerEmail" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
            </div>
            <div class="form-actions">
                <button onclick="performRegister()" class="btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button onclick="hideRegisterForm()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è -->
    <div id="recoveryForm" class="form-overlay">
        <div class="form-container">
            <h3>üîê –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h3>
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="recoveryUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="recoveryEmail" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
            </div>
            <div class="form-actions">
                <button onclick="performRecovery()" class="btn-primary">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <button onclick="hideRecoveryForm()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ -->
    <div id="addContactForm" class="form-overlay">
        <div class="form-container">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞:</label>
                <input type="text" id="contactUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="form-actions">
                <button onclick="performAddContact()" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button onclick="hideAddContactForm()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div id="createGroupForm" class="form-overlay">
        <div class="form-container">
            <h3>üè† –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                <input type="text" id="groupName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            </div>
            <div class="form-group">
                <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                <input type="text" id="groupMembers" placeholder="user1, user2, user3">
            </div>
            <div class="form-actions">
                <button onclick="performCreateGroup()" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                <button onclick="hideCreateGroupForm()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification" class="notification"></div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let currentChat = null;
        let chatType = null; // 'contact' –∏–ª–∏ 'group'
        let wsConnection = null;
        let messageQueue = [];
        let isConnected = false;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º
        function getStoredServer() {
            return localStorage.getItem('messenger_server');
        }

        function setStoredServer(server) {
            localStorage.setItem('messenger_server', server);
        }

        function connectToServer() {
            const server = document.getElementById('serverInput').value.trim();
            if (!server) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                return;
            }
            initializeApp(server, false);
        }

        function saveAndConnect() {
            const server = document.getElementById('serverInput').value.trim();
            if (!server) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                return;
            }
            initializeApp(server, true);
        }

        function showConfig() {
            document.getElementById('serverConfig').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            disconnectWebSocket();
            currentUser = null;
            updateUI();
        }

        function initializeApp(server, saveToStorage = false) {
            if (saveToStorage) {
                setStoredServer(server);
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            document.getElementById('serverConfig').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('currentServer').textContent = server;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            window.SERVER_ADDRESS = server;
            window.API_BASE = `http://${server}`;
            
            console.log('Connecting to:', window.API_BASE);
            showNotification('–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');
        }

        // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        function connectWebSocket() {
            if (!currentUser) return;
            
            try {
                const wsUrl = `ws://${window.SERVER_ADDRESS}/ws?username=${currentUser}`;
                wsConnection = new WebSocket(wsUrl);
                
                wsConnection.onopen = function() {
                    console.log('WebSocket connected');
                    isConnected = true;
                    showNotification('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–∏–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
                    while (messageQueue.length > 0) {
                        const message = messageQueue.shift();
                        wsConnection.send(JSON.stringify(message));
                    }
                };
                
                wsConnection.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleIncomingMessage(data);
                };
                
                wsConnection.onclose = function() {
                    console.log('WebSocket disconnected');
                    isConnected = false;
                    showNotification('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
                    
                    // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(connectWebSocket, 5000);
                };
                
                wsConnection.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    showNotification('–û—à–∏–±–∫–∞ WebSocket', 'error');
                };
                
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket', 'error');
            }
        }

        function disconnectWebSocket() {
            if (wsConnection) {
                wsConnection.close();
                wsConnection = null;
            }
            isConnected = false;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function handleIncomingMessage(data) {
            if (data.type === 'message') {
                displayMessage(data);
            } else if (data.type === 'notification') {
                showNotification(data.message, data.status || 'info');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'flex';
        }

        function hideLoginForm() {
            document.getElementById('loginForm').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('registerForm').style.display = 'flex';
        }

        function hideRegisterForm() {
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRecoveryForm() {
            hideLoginForm();
            document.getElementById('recoveryForm').style.display = 'flex';
        }

        function hideRecoveryForm() {
            document.getElementById('recoveryForm').style.display = 'none';
        }

        function showAddContactForm() {
            if (!currentUser) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                return;
            }
            document.getElementById('addContactForm').style.display = 'flex';
        }

        function hideAddContactForm() {
            document.getElementById('addContactForm').style.display = 'none';
        }

        function showCreateGroupForm() {
            if (!currentUser) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                return;
            }
            document.getElementById('createGroupForm').style.display = 'flex';
        }

        function hideCreateGroupForm() {
            document.getElementById('createGroupForm').style.display = 'none';
        }

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        async function makeRequest(action, data = {}) {
            try {
                const request = {
                    action: action,
                    username: currentUser,
                    ...data
                };

                const response = await fetch(`http://${window.SERVER_ADDRESS}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API request failed:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return { status: 'error', message: 'Connection failed' };
            }
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function performLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            const result = await makeRequest('login', { username, password });
            
            if (result.status === 'success') {
                currentUser = username;
                hideLoginForm();
                updateUI();
                connectWebSocket();
                loadContacts();
                loadGroups();
                showNotification('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É', 'success');
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function performRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value.trim();

            if (!username || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            const result = await makeRequest('register', { username, password, email });
            
            if (result.status === 'success') {
                hideRegisterForm();
                showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'success');
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function performRecovery() {
            const username = document.getElementById('recoveryUsername').value.trim();
            const email = document.getElementById('recoveryEmail').value.trim();

            if (!username || !email) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            const result = await makeRequest('recover', { username, email });
            
            if (result.status === 'success') {
                hideRecoveryForm();
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
        }

        // –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≥—Ä—É–ø–ø—ã
        async function performAddContact() {
            const contact = document.getElementById('contactUsername').value.trim();

            if (!contact) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            const result = await makeRequest('add_contact', { contact });
            
            if (result.status === 'success') {
                hideAddContactForm();
                loadContacts();
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function performCreateGroup() {
            const name = document.getElementById('groupName').value.trim();
            const membersInput = document.getElementById('groupMembers').value.trim();
            const members = membersInput ? membersInput.split(',').map(m => m.trim()) : [];

            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
                return;
            }

            const result = await makeRequest('create_group', { name, members });
            
            if (result.status === 'success') {
                hideCreateGroupForm();
                loadGroups();
                showNotification('–ì—Ä—É–ø–ø–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞', 'success');
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function loadContacts() {
            if (!currentUser) return;

            const result = await makeRequest('get_contacts');
            if (result.status === 'success') {
                displayContacts(result.data || []);
            }
        }

        async function loadGroups() {
            if (!currentUser) return;

            // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ API
            // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
            const groups = [];
            displayGroups(groups);
        }

        function displayContacts(contacts) {
            const container = document.getElementById('contactsList');
            container.innerHTML = '';

            if (contacts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            contacts.forEach(contact => {
                const element = document.createElement('div');
                element.className = 'contact-item';
                element.textContent = contact;
                element.onclick = () => selectChat(contact, 'contact');
                container.appendChild(element);
            });
        }

        function displayGroups(groups) {
            const container = document.getElementById('groupsList');
            container.innerHTML = '';

            if (groups.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            groups.forEach(group => {
                const element = document.createElement('div');
                element.className = 'group-item';
                element.innerHTML = `
                    <strong>${group.name}</strong>
                    <div style="font-size: 12px; color: #666;">${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                `;
                element.onclick = () => selectChat(group.id, 'group', group.name);
                container.appendChild(element);
            });
        }

        // –†–∞–±–æ—Ç–∞ —Å —á–∞—Ç–æ–º
        function selectChat(target, type, name = null) {
            currentChat = target;
            chatType = type;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.querySelectorAll('.contact-item, .group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            const chatTitle = document.getElementById('chatTitle');
            if (type === 'contact') {
                chatTitle.textContent = `üí¨ –ß–∞—Ç —Å ${target}`;
            } else {
                chatTitle.textContent = `üë• ${name || target}`;
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            loadMessages();
        }

        async function loadMessages() {
            if (!currentUser || !currentChat) return;

            const result = await makeRequest('get_messages');
            if (result.status === 'success') {
                displayMessages(result.data || []);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
            const chatMessages = messages.filter(msg => {
                if (chatType === 'contact') {
                    return (msg.from === currentChat && msg.to === currentUser) || 
                           (msg.from === currentUser && msg.to === currentChat);
                } else {
                    return msg.group_id === currentChat;
                }
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            chatMessages.sort((a, b) => new Date(a.sent_at) - new Date(b.sent_at));

            if (chatMessages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }

            chatMessages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.from === currentUser ? 'own' : 'other'} fade-in`;
                
                const time = new Date(msg.sent_at).toLocaleTimeString();
                messageElement.innerHTML = `
                    <div class="message-header">${msg.from} ‚Ä¢ ${time}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                `;
                
                container.appendChild(messageElement);
            });

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentChat) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
                return;
            }

            const messageData = {
                action: 'send_message',
                to: chatType === 'contact' ? currentChat : '',
                content: content,
                is_group: chatType === 'group',
                group_id: chatType === 'group' ? currentChat : ''
            };

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
            const tempMessage = {
                id: Date.now(),
                from: currentUser,
                to: currentChat,
                content: content,
                sent_at: new Date().toISOString(),
                is_group: chatType === 'group',
                group_id: chatType === 'group' ? currentChat : ''
            };
            
            displayMessages([tempMessage]);

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const result = await makeRequest('send_message', messageData);
            
            if (result.status !== 'success') {
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function updateUI() {
            const usernameElement = document.getElementById('currentUsername');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');

            if (currentUser) {
                usernameElement.textContent = currentUser;
                loginBtn.textContent = 'üö™ –í—ã–π—Ç–∏';
                loginBtn.onclick = logout;
                registerBtn.style.display = 'none';
            } else {
                usernameElement.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                loginBtn.textContent = 'üîë –í–æ–π—Ç–∏';
                loginBtn.onclick = showLoginForm;
                registerBtn.style.display = 'block';
                
                // –û—á–∏—â–∞–µ–º —á–∞—Ç—ã
                document.getElementById('contactsList').innerHTML = '';
                document.getElementById('groupsList').innerHTML = '';
                document.getElementById('messagesContainer').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ P2P Messenger!</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –≥—Ä—É–ø–ø—É —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                    </div>
                `;
            }
        }

        function logout() {
            currentUser = null;
            currentChat = null;
            chatType = null;
            disconnectWebSocket();
            updateUI();
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            const savedServer = getStoredServer();
            if (savedServer) {
                document.getElementById('serverInput').value = savedServer;
                initializeApp(savedServer, false);
            }
        });
    </script>
</body>
</html>